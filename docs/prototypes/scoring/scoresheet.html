<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scoresheet Prototype - Archery Event</title>
    <script src="../mock-data/languages.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: white; padding: 0; margin: 0; overflow: hidden; display: flex; justify-content: center; align-items: center; }
        
        /* Full screen container - mobile */
        .device-frame { 
            width: 100vw; 
            height: 100vh;
            background: white; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
            position: relative; 
        }
        
        /* Desktop/Tablet Landscape - 50% width centered */
        @media (min-width: 600px) {
            body { background: #e0e0e0; }
            .device-frame {
                width: 50vw;
                box-shadow: 0 0 32px rgba(0,0,0,0.3);
            }
        }
        .scoresheet-header { background: linear-gradient(135deg, #1565c0 0%, #1976d2 100%); color: white; padding: 16px 12px; display: grid; grid-template-columns: 40px repeat(5, 1fr) 40px 40px; gap: 4px; align-items: center; }
        .back-btn { background: transparent; border: none; color: white; font-size: 24px; cursor: pointer; padding: 8px; display: flex; align-items: center; justify-content: flex-start; border-radius: 8px; transition: background 0.2s; grid-column: 1 / 2; }
        .back-btn:hover { background: rgba(255, 255, 255, 0.15); }
        .back-btn:active { background: rgba(255, 255, 255, 0.25); }
        .header-content { grid-column: 2 / 7; display: flex; flex-direction: column; align-items: center; text-align: center; }
        .scoresheet-header h2 { font-size: 18px; font-weight: 600; }
        
        .header-language { grid-column: 7 / 8; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; border-radius: 50%; background: rgba(255, 255, 255, 0.2); transition: background 0.2s; font-size: 24px; position: relative; }
        .header-language:hover { background: rgba(255, 255, 255, 0.3); }
        
        .header-profile { grid-column: 8 / 9; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; border-radius: 50%; background: rgba(255, 255, 255, 0.2); transition: background 0.2s; }
        .header-profile:hover { background: rgba(255, 255, 255, 0.3); }
        .header-profile-icon { font-size: 24px; }
        
        /* Language Dropdown */
        .language-dropdown { position: absolute; top: calc(100% + 8px); right: 0; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); min-width: 200px; display: none; z-index: 1000; overflow: hidden; }
        .language-dropdown.show { display: block; }
        .language-item { padding: 12px 16px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: background 0.2s; color: #424242; font-size: 14px; border: none; width: 100%; text-align: left; background: white; }
        .language-item:hover { background: #f5f5f5; }
        .language-item.active { background: #e3f2fd; color: #1565c0; font-weight: 600; }
        .language-flag { font-size: 20px; }
        .language-name { flex: 1; }
        
        /* Desktop - Keep mobile size for consistency */
        @media (min-width: 960px) {
            .scoresheet-header { padding: 16px; }
        }
        .ends-list { flex: 1; overflow-y: auto; overflow-x: hidden; padding: 8px 12px; scrollbar-width: none; -ms-overflow-style: none; }
        .ends-list::-webkit-scrollbar { display: none; }
        .phase-header { background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%); padding: 12px; margin: 8px -12px; border-left: 4px solid #1565c0; display: flex; justify-content: space-between; align-items: center; }
        .phase-title { font-size: 16px; font-weight: 700; color: #1565c0; margin: 0; }
        .phase-stats { display: flex; gap: 16px; font-size: 13px; color: #666; }
        .phase-stats span { font-weight: 600; }
        .phase-stats strong { color: #212121; }
        .end-row { display: grid; grid-template-columns: 40px repeat(6, 1fr) 60px; gap: 4px; align-items: center; padding: 6px 0; margin-bottom: 2px; border-bottom: 1px solid #f0f0f0; }
        .end-row.active { background: rgba(21, 101, 192, 0.05); }
        .end-row.active .arrow-cell { box-shadow: 0 0 0 2px #1565c0; }
        .end-row.locked { opacity: 0.6; }
        .end-number { font-size: 14px; font-weight: 600; color: #666; text-align: center; }
        .arrow-cell { width: 100%; aspect-ratio: 1; max-width: 38px; justify-self: center; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .arrow-cell.empty { background: #e0e0e0; color: #999; }
        .end-actions { display: flex; flex-direction: row; align-items: center; gap: 4px; justify-content: center; }
        .action-btn { width: 28px; height: 28px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; transition: transform 0.1s; font-weight: bold; flex-shrink: 0; }
        
        /* Desktop - Keep mobile size, just add hover effects */
        @media (min-width: 960px) {
            .action-btn:hover { transform: scale(1.05); }
        }
        .action-btn:active { transform: scale(0.95); }
        .btn-confirm { background: #4caf50; color: white; }
        .btn-cancel { background: #f44336; color: white; }
        .end-sum { font-weight: 700; color: #ff6f00; font-size: 14px; text-align: center; }
        .score-pad { background: linear-gradient(180deg, #fafafa 0%, #f0f0f0 100%); padding: 12px; border-top: 1px solid #e0e0e0; display: flex; flex-direction: column; justify-content: center; }
        .live-stats { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 13px; font-weight: 600; color: #666; }
        .score-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; width: 100%; height: 100%; }
        .score-btn { border-radius: 8px; border: none; font-weight: 700; font-size: 18px; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.3); transition: all 0.1s; width: 100%; height: 100%; min-height: 50px; }
        @media (min-width: 600px) {
            .score-btn { font-size: clamp(14px, 2.5vh, 20px); }
        }
        
        /* Desktop - Keep mobile size, just add hover effects */
        @media (min-width: 960px) {
            .score-btn:hover:not(:disabled) { transform: scale(1.05); box-shadow: 0 4px 8px rgba(0,0,0,0.4); }
        }
        .score-btn:active { transform: scale(0.95); box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        .score-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .ring-yellow { background: #e8de27; color: #000; }
        .ring-red { background: #d92d41; color: white; }
        .ring-blue { background: #1884cc; color: white; }
        .ring-black { background: #000000; color: white; }
        .ring-white { background: #f5f5f5; color: #000; border: 2px solid #ccc; }
        .ring-green { background: #0a8c0a; color: white; }
        .btn-delete { background: #9e9e9e; color: white; font-size: 22px; }
        .btn-empty { background: transparent; cursor: default; box-shadow: none; }
        .lock-icon { display: inline-block; color: #4caf50; font-size: 16px; margin-left: 4px; }
        .saving-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; z-index: 999; }
        
        /* Responsive indicator badge (for testing) */
        .responsive-badge {
            position: fixed;
            bottom: 10px;
            right: 10px;
            padding: 6px 12px;
            background: rgba(0,0,0,0.7);
            color: white;
            font-size: 11px;
            border-radius: 12px;
            font-weight: 600;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }
        
        .responsive-badge::before {
            content: '📱 Mobile';
        }
        
        @media (min-width: 600px) and (max-width: 959px) {
            .responsive-badge::before {
                content: '📱 Tablet';
            }
        }
        
        @media (min-width: 960px) and (max-width: 1279px) {
            .responsive-badge::before {
                content: '💻 Desktop';
            }
        }
        
        @media (min-width: 1280px) {
            .responsive-badge::before {
                content: '🖥️ Desktop XL';
            }
        }
    </style>
</head>
<body>
    <div class="responsive-badge"></div>
    <div class="device-frame">
        <div class="scoresheet-header">
            <button class="back-btn" onclick="goBack()">←</button>
            <div class="header-content">
                <h2 id="competitionName">Men's 70m Qualification</h2>
            </div>
            <div class="header-language" id="languageSelector" onclick="toggleLanguageDropdown()">
                <span id="currentLanguageFlag">🇺🇸</span>
                <div class="language-dropdown" id="languageDropdown"></div>
            </div>
            <div class="header-profile" onclick="alert('Profile clicked')">
                <span class="header-profile-icon">👤</span>
            </div>
        </div>
        <div class="ends-list" id="endsList"></div>
        <div class="score-pad">
            <div class="live-stats">
                <span>Total: <strong id="totalScore">0</strong> / <strong id="maxScore">0</strong></span>
                <span>Avg: <strong id="liveAvg">0.00</strong></span>
            </div>
            <div class="score-grid">
                <button class="score-btn ring-yellow" data-score="X">X</button>
                <button class="score-btn ring-yellow" data-score="10">10</button>
                <button class="score-btn ring-yellow" data-score="9">9</button>
                <button class="score-btn ring-red" data-score="8">8</button>
                <button class="score-btn btn-delete" id="deleteBtn">←</button>
                <button class="score-btn ring-red" data-score="7">7</button>
                <button class="score-btn ring-blue" data-score="6">6</button>
                <button class="score-btn ring-blue" data-score="5">5</button>
                <button class="score-btn ring-black" data-score="4">4</button>
                <button class="score-btn btn-empty"></button>
                <button class="score-btn ring-black" data-score="3">3</button>
                <button class="score-btn ring-white" data-score="2">2</button>
                <button class="score-btn ring-white" data-score="1">1</button>
                <button class="score-btn ring-green" data-score="M">M</button>
                <button class="score-btn btn-empty"></button>
            </div>
        </div>
        <div class="saving-overlay" id="savingOverlay" style="display: none;">Saving...</div>
    </div>
    <script src="../mock-data/rounds.js"></script>
    <script>
        // Language selector functionality
        function initLanguageSelector() {
            const currentLang = getCurrentLanguage();
            document.getElementById('currentLanguageFlag').textContent = currentLang.flag;
            renderLanguageDropdown();
        }

        function renderLanguageDropdown() {
            const dropdown = document.getElementById('languageDropdown');
            const languages = getSupportedLanguages();
            const currentLang = getCurrentLanguage();
            
            dropdown.innerHTML = languages.map(lang => `
                <button class="language-item ${lang.code === currentLang.code ? 'active' : ''}" onclick="selectLanguage('${lang.code}')">
                    <span class="language-flag">${lang.flag}</span>
                    <span class="language-name">${lang.nativeName}</span>
                </button>
            `).join('');
        }

        function toggleLanguageDropdown() {
            const dropdown = document.getElementById('languageDropdown');
            dropdown.classList.toggle('show');
        }

        function selectLanguage(languageCode) {
            const language = setCurrentLanguage(languageCode);
            document.getElementById('currentLanguageFlag').textContent = language.flag;
            renderLanguageDropdown();
            toggleLanguageDropdown();
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const languageSelector = document.getElementById('languageSelector');
            const dropdown = document.getElementById('languageDropdown');
            if (!languageSelector.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Initialize language selector
        initLanguageSelector();

        // Get subround from URL or default to WA 900 for demo
        const urlParams = new URLSearchParams(window.location.search);
        const subroundName = urlParams.get('subround') || 'WA 900';
        const subroundPhases = getSubroundDetails(subroundName) || [{ distance: "70m", targetSize: "122cm", ends: 12, target: "Metric 10 Zone", arrows: 72 }];
        
        const state = { ends: [], currentEndIndex: 0, arrowsPerEnd: 6, totalEnds: 0, phases: subroundPhases }
        function initEnds() { 
            let endCounter = 1;
            state.phases.forEach((phase, phaseIdx) => {
                for (let i = 0; i < phase.ends; i++) { 
                    state.ends.push({ 
                        endNumber: endCounter++, 
                        arrows: Array(state.arrowsPerEnd).fill(null), 
                        confirmed: false,
                        phaseIndex: phaseIdx
                    }) 
                }
            });
            state.totalEnds = state.ends.length;
            render();
        }
        
        function render() { 
            const list = document.getElementById('endsList'); 
            list.innerHTML = ''; 
            
            let currentPhase = -1;
            state.ends.forEach((end, idx) => { 
                // Insert phase header when phase changes
                if (end.phaseIndex !== currentPhase) {
                    currentPhase = end.phaseIndex;
                    const phase = state.phases[currentPhase];
                    
                    // Calculate phase stats
                    const phaseEnds = state.ends.filter(e => e.phaseIndex === currentPhase);
                    const phaseTotal = phaseEnds.filter(e => e.confirmed).reduce((s, e) => s + calcSum(e.arrows), 0);
                    const phaseArrows = phaseEnds.filter(e => e.confirmed).reduce((c, e) => c + e.arrows.filter(a => a).length, 0);
                    const phaseGolds = phaseEnds.filter(e => e.confirmed).reduce((c, e) => c + e.arrows.filter(a => a === 'X' || a === '10').length, 0);
                    const phaseAvg = phaseArrows > 0 ? (phaseTotal / phaseArrows).toFixed(2) : '0.00';
                    
                    const phaseHeader = document.createElement('div');
                    phaseHeader.className = 'phase-header';
                    phaseHeader.innerHTML = `
                        <div class="phase-title">Distance: ${phase.distance}</div>
                        <div class="phase-stats">
                            <span>Golds: <strong>${phaseGolds}</strong></span>
                            <span>Avg: <strong>${phaseAvg}</strong></span>
                            <span>Total: <strong>${phaseTotal}</strong> / ${phase.ends * 6 * 10}</span>
                        </div>
                    `;
                    list.appendChild(phaseHeader);
                }
                
                const isActive = idx === state.currentEndIndex && !end.confirmed; 
                const row = document.createElement('div'); 
                row.className = 'end-row' + (isActive ? ' active' : '') + (end.confirmed ? ' locked' : ''); 
                const sum = calcSum(end.arrows); 
                const allFilled = end.arrows.every(a => a !== null); 
                const arrowsHtml = end.arrows.map(a => '<div class="arrow-cell'+(a ? '' : ' empty')+'" style="'+getArrowStyle(a)+'">'+(a || '-')+'</div>').join(''); 
                const actionsHtml = '<div class="end-actions">'+(isActive && allFilled && !end.confirmed ? '<button class="action-btn btn-confirm" onclick="confirmEnd()">✓</button>' : '')+'<div class="end-sum">'+(sum || '')+'</div></div>'; 
                row.innerHTML = '<div class="end-number">'+end.endNumber+'</div>'+arrowsHtml+actionsHtml; 
                list.appendChild(row);
            }); 
            
            updateStats(); 
            document.getElementById('deleteBtn').disabled = !canDelete();
        }
        function getArrowStyle(val) { if (!val) return ''; const colors = { X: 'background:#e8de27;color:#000', '10': 'background:#e8de27;color:#000', '9': 'background:#e8de27;color:#000', '8': 'background:#d92d41;color:white', '7': 'background:#d92d41;color:white', '6': 'background:#1884cc;color:white', '5': 'background:#1884cc;color:white', '4': 'background:#000;color:white', '3': 'background:#000;color:white', '2': 'background:#f5f5f5;color:#000;border:2px solid #ccc', '1': 'background:#f5f5f5;color:#000;border:2px solid #ccc', M: 'background:#0a8c0a;color:white' }; return colors[val] || '' }
        function calcSum(arrows) { return arrows.reduce((s, a) => s + scoreVal(a), 0) }
        function scoreVal(v) { if (v === 'X' || v === '10') return 10; if (v === 'M' || !v) return 0; return parseInt(v) }
        function updateStats() { 
            // Calculate for confirmed ends
            const confirmedTotal = state.ends.filter(e => e.confirmed).reduce((s, e) => s + calcSum(e.arrows), 0); 
            const confirmedArrows = state.ends.filter(e => e.confirmed).reduce((c, e) => c + e.arrows.filter(a => a).length, 0); 
            
            // Include current end in progress for live stats
            const currentEnd = state.ends[state.currentEndIndex];
            const currentArrows = currentEnd.arrows.filter(a => a);
            const currentSum = calcSum(currentEnd.arrows);
            
            const totalWithCurrent = confirmedTotal + currentSum;
            const arrowsWithCurrent = confirmedArrows + currentArrows.length;
            const avg = arrowsWithCurrent > 0 ? (totalWithCurrent / arrowsWithCurrent).toFixed(2) : '0.00'; 
            
            document.getElementById('totalScore').textContent = totalWithCurrent; 
            document.getElementById('maxScore').textContent = state.totalEnds * state.arrowsPerEnd * 10; 
            document.getElementById('liveAvg').textContent = avg;
            
            // Update competition name header with subround name
            document.getElementById('competitionName').textContent = subroundName;
        }
        function inputScore(score) { const end = state.ends[state.currentEndIndex]; if (end.confirmed) return; const emptyIdx = end.arrows.findIndex(a => a === null); if (emptyIdx !== -1) { end.arrows[emptyIdx] = score; render() } }
        function canDelete() { const end = state.ends[state.currentEndIndex]; return end && !end.confirmed && end.arrows.some(a => a !== null) }
        function deleteLast() { if (!canDelete()) return; const end = state.ends[state.currentEndIndex]; for (let i = end.arrows.length - 1; i >= 0; i--) { if (end.arrows[i] !== null) { end.arrows[i] = null; break } } render() }
        function confirmEnd() { const end = state.ends[state.currentEndIndex]; if (end.arrows.some(a => a === null)) return; document.getElementById('savingOverlay').style.display = 'flex'; setTimeout(() => { end.confirmed = true; document.getElementById('savingOverlay').style.display = 'none'; if (state.currentEndIndex < state.totalEnds - 1) state.currentEndIndex++; render() }, 800) }
        function goBack() { if (confirm('Are you sure you want to go back? Unsaved progress may be lost.')) { window.history.back() } }
        document.querySelectorAll('.score-btn[data-score]').forEach(btn => { btn.addEventListener('click', () => inputScore(btn.dataset.score)) }); document.getElementById('deleteBtn').addEventListener('click', deleteLast); initEnds()
    </script>
</body>
</html>
